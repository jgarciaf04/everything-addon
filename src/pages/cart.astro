---
import type { Addon } from '../types/addon';
import NavHeader from '../components/NavHeader.astro';
import '../styles/global.css';
import addons from '../data/addons.json';
---

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" />
  <title>Cart — Everything Addon</title>
</head>
<body>
  <NavHeader />

  <main class="cart-page">
    <!-- ── Page Heading ─────────────────────────────────────────────────── -->
    <h1 class="cart-title">Your Cart</h1>

    <!-- ── Cart Item List ───────────────────────────────────────────────── -->
    <div id="cart-list" class="cart-list"></div>

    <!-- ── Cart Summary ─────────────────────────────────────────────────── -->
    <div id="cart-summary" class="cart-summary" hidden>
      <div class="cart-total-row">
        <span class="cart-total-label">Total</span>
        <span id="cart-total" class="cart-total-value">$0.00</span>
      </div>
      <a id="preview-btn" class="preview-btn" href="/preview">Preview &amp; Generate</a>
    </div>

    <!-- ── Empty State ──────────────────────────────────────────────────── -->
    <div id="cart-empty" class="cart-empty" hidden>
      <p class="cart-empty-message">Your cart is empty</p>
      <a class="cart-empty-link" href="/catalog">Browse the Catalog</a>
    </div>
  </main>

  <!-- Hidden addon data for client script -->
  <script id="addon-data" type="application/json" set:html={JSON.stringify(addons)} />
</body>
</html>

<style>
  /* ── Page Container ──────────────────────────────────────────────────── */

  .cart-page {
    max-width: 1280px;
    margin: 0 auto;
    padding: var(--space-5) var(--space-4) var(--space-7);
  }

  /* ── Page Title ──────────────────────────────────────────────────────── */

  .cart-title {
    font-family: var(--font-heading);
    font-size: var(--text-2xl);
    color: var(--color-primary);
    margin-bottom: var(--space-5);
  }

  /* ── Cart Item List ──────────────────────────────────────────────────── */

  .cart-list {
    display: flex;
    flex-direction: column;
    gap: var(--space-3);
    margin-bottom: var(--space-5);
  }

  /* ── Cart Item Card ──────────────────────────────────────────────────── */

  .card-item {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: var(--space-3);
    background: var(--color-bg-mid);
    border: var(--space-1) solid var(--color-border);
    border-radius: var(--border-radius);
    padding: var(--space-3) var(--space-4);
    transition: border-color 0.15s;
  }

  .card-item:hover {
    border-color: var(--color-primary);
  }

  .card-item-info {
    display: flex;
    align-items: center;
    gap: var(--space-4);
    flex: 1;
    min-width: 0;
  }

  .card-item-name {
    font-family: var(--font-heading);
    font-size: var(--text-sm);
    color: var(--color-text-light);
    margin: 0;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  .card-item-price {
    font-family: var(--font-heading);
    font-size: var(--text-sm);
    color: var(--color-accent);
    white-space: nowrap;
  }

  /* ── Remove Button ─────────────────────────────────────────────────── */

  .cart-btn-remove {
    font-family: var(--font-heading);
    font-size: var(--text-xs);
    color: var(--color-text-light);
    background: var(--color-clay);
    border: var(--space-1) solid var(--color-border);
    border-radius: var(--border-radius);
    padding: var(--space-2) var(--space-3);
    cursor: pointer;
    transition: background 0.15s, border-color 0.15s;
    text-align: center;
    white-space: nowrap;
  }

  .cart-btn-remove:hover,
  .cart-btn-remove:focus-visible {
    background: var(--color-accent);
    border-color: var(--color-oak);
  }

  /* ── Cart Summary ──────────────────────────────────────────────────── */

  .cart-summary {
    background: var(--color-bg-mid);
    border: var(--space-1) solid var(--color-border);
    border-radius: var(--border-radius);
    padding: var(--space-4);
    display: flex;
    flex-direction: column;
    gap: var(--space-4);
  }

  .cart-total-row {
    display: flex;
    justify-content: space-between;
    align-items: baseline;
    padding: var(--space-2) 0;
    border-bottom: var(--space-1) solid var(--color-border);
  }

  .cart-total-label {
    font-family: var(--font-heading);
    font-size: var(--text-base);
    color: var(--color-text-light);
  }

  .cart-total-value {
    font-family: var(--font-heading);
    font-size: var(--text-2xl);
    color: var(--color-accent);
  }

  /* ── Preview & Generate Button ─────────────────────────────────────── */

  .preview-btn {
    display: block;
    font-family: var(--font-heading);
    font-size: var(--text-sm);
    color: var(--color-text-light);
    background: var(--color-primary);
    border: var(--space-1) solid var(--color-moss);
    border-radius: var(--border-radius);
    padding: var(--space-3) var(--space-5);
    cursor: pointer;
    transition: background 0.15s, border-color 0.15s;
    box-shadow: var(--space-1) var(--space-1) 0 var(--color-moss);
    text-align: center;
    text-decoration: none;
  }

  .preview-btn:hover,
  .preview-btn:focus-visible {
    background: var(--color-accent);
    border-color: var(--color-oak);
    box-shadow: var(--space-1) var(--space-1) 0 var(--color-oak);
  }

  /* ── Empty State ───────────────────────────────────────────────────── */

  .cart-empty {
    text-align: center;
    padding: var(--space-7) var(--space-4);
  }

  .cart-empty-message {
    font-family: var(--font-heading);
    font-size: var(--text-lg);
    color: var(--color-stone);
    margin: 0 0 var(--space-4);
  }

  .cart-empty-link {
    display: inline-block;
    font-family: var(--font-heading);
    font-size: var(--text-sm);
    color: var(--color-text-light);
    background: var(--color-primary);
    border: var(--space-1) solid var(--color-moss);
    border-radius: var(--border-radius);
    padding: var(--space-2) var(--space-4);
    text-decoration: none;
    box-shadow: var(--space-1) var(--space-1) 0 var(--color-moss);
    transition: background 0.15s, border-color 0.15s;
  }

  .cart-empty-link:hover,
  .cart-empty-link:focus-visible {
    background: var(--color-accent);
    border-color: var(--color-oak);
    box-shadow: var(--space-1) var(--space-1) 0 var(--color-oak);
  }

  /* ── Responsive: mobile (375px+) ──────────────────────────────────── */

  @media (max-width: 640px) {
    .cart-page {
      padding: var(--space-4) var(--space-3) var(--space-6);
    }

    .cart-title {
      font-size: var(--text-lg);
      margin-bottom: var(--space-4);
    }

    .card-item {
      flex-direction: column;
      align-items: stretch;
      gap: var(--space-2);
      padding: var(--space-3);
    }

    .card-item-info {
      flex-direction: column;
      align-items: flex-start;
      gap: var(--space-2);
    }

    .card-item-name {
      font-size: var(--text-xs);
    }

    .card-item-price {
      font-size: var(--text-xs);
    }

    .cart-btn-remove {
      align-self: flex-end;
    }

    .cart-total-value {
      font-size: var(--text-xl);
    }

    .preview-btn {
      font-size: var(--text-xs);
      padding: var(--space-2) var(--space-4);
    }
  }
</style>

<script>
  import type { Addon } from '../types/addon';
  import { getCartItems, removeFromCart, onCartChange } from '../scripts/cart';

  // ── Read addon data from embedded JSON ──────────────────────────────────
  const dataEl = document.getElementById('addon-data');
  if (!dataEl) throw new Error('Missing addon-data script element');

  const allAddons: Addon[] = JSON.parse(dataEl.textContent || '[]');

  const cartList = document.getElementById('cart-list') as HTMLDivElement;
  const cartSummary = document.getElementById('cart-summary') as HTMLDivElement;
  const cartTotal = document.getElementById('cart-total') as HTMLSpanElement;
  const cartEmpty = document.getElementById('cart-empty') as HTMLDivElement;

  /** Build an addon lookup map for fast access by id. */
  const addonMap = new Map<string, Addon>();
  for (const addon of allAddons) {
    addonMap.set(addon.id, addon);
  }

  /** Render the full cart UI based on current cart state. */
  function renderCart(): void {
    const ids = getCartItems();
    cartList.innerHTML = '';

    if (ids.length === 0) {
      cartSummary.hidden = true;
      cartEmpty.hidden = false;
      return;
    }

    cartSummary.hidden = false;
    cartEmpty.hidden = true;

    let total = 0;

    for (const id of ids) {
      const addon = addonMap.get(id);
      if (!addon) continue;

      total += addon.price;

      const row = document.createElement('div');
      row.className = 'card-item';

      const info = document.createElement('div');
      info.className = 'card-item-info';

      const name = document.createElement('h3');
      name.className = 'card-item-name';
      name.textContent = addon.name;

      const price = document.createElement('span');
      price.className = 'card-item-price';
      price.textContent = `$${addon.price.toFixed(2)}`;

      info.appendChild(name);
      info.appendChild(price);

      const removeBtn = document.createElement('button');
      removeBtn.className = 'cart-btn-remove';
      removeBtn.type = 'button';
      removeBtn.textContent = 'Remove';
      removeBtn.setAttribute('aria-label', `Remove ${addon.name} from cart`);
      removeBtn.addEventListener('click', () => {
        removeFromCart(id);
      });

      row.appendChild(info);
      row.appendChild(removeBtn);
      cartList.appendChild(row);
    }

    cartTotal.textContent = `$${total.toFixed(2)}`;
  }

  // Initial render
  renderCart();

  // Subscribe to cart changes for cross-tab sync
  onCartChange(() => {
    renderCart();
  });
</script>
